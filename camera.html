<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæœè£…åˆ†æ - å°±æ´»ã‚µãƒãƒ¼ãƒˆ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- lucide (ã‚¢ã‚¤ã‚³ãƒ³) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <!-- Chart.js (ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆç”¨) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            /* â˜… ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•ã‚’ 4rem (64px) ã«å¤‰æ›´ */
            padding-top: 64px; 
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        .drag-over { border-color: #6d28d9; background-color: #f5f3ff; }
        #analysisResult h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; margin-top: 1rem; }
        #analysisResult ul { list-style-type: disc; margin-left: 1.5rem; }
        #analysisResult li { margin-bottom: 0.5rem; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #6d28d9; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">

    <!-- === ãƒ˜ãƒƒãƒ€ãƒ¼ (camera.html å°‚ç”¨) === -->
    <!-- â˜… é«˜ã•ã‚’ h-18 (4.5rem) ã‹ã‚‰ h-16 (4rem) ã«å¤‰æ›´ -->
    <nav class="fixed top-0 left-0 right-0 bg-white shadow-md z-50 h-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- â˜… h-18 py-2 ã‚’ h-16 flex items-center ã«å¤‰æ›´ -->
            <div class="flex justify-between items-center h-16">
                <a href="home.html" class="flex-shrink-0 flex items-center gap-2">
                    <svg class="h-8 w-8 text-sky-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/><circle cx="12" cy="10" r="3"/></svg>
                    <span class="text-2xl font-bold text-gray-800">å°±æ´»ã‚µãƒãƒ¼ãƒˆ</span>
                </a>
                <a href="home.html" class="flex items-center text-gray-600 hover:text-sky-600 transition-colors">
                    <svg class="lucide lucide-arrow-left w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                    ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                </a>
            </div>
        </div>
    </nav>
    <!-- === ãƒ˜ãƒƒãƒ€ãƒ¼ã“ã“ã¾ã§ === -->

    <div class="w-full max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-10 my-12">
        
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-6">
            âœ¨ AIæœè£…åˆ†æ
        </h1>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—1: å ´é¢é¸æŠ -->
        <div class="mb-6">
            <label for="sceneSelect" class="block text-lg font-semibold text-gray-700 mb-2">1. åˆ†æã—ãŸã„å ´é¢ã‚’é¸æŠ</label>
            <select id="sceneSelect" class="w-full p-3 border border-gray-300 rounded-lg bg-white text-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                <option value="" disabled selected>-- å ´é¢ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
                <option value="æœ€çµ‚é¢æ¥ï¼ˆå …ã‚ï¼‰">æœ€çµ‚é¢æ¥ï¼ˆå …ã‚ï¼‰</option>
                <option value="ä¸€èˆ¬é¢æ¥ï¼ˆæ¨™æº–ï¼‰">ä¸€èˆ¬é¢æ¥ï¼ˆæ¨™æº–ï¼‰</option>
                <option value="ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«é¢è«‡ï¼ˆç§æœå¯ï¼‰">ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«é¢è«‡ï¼ˆç§æœå¯ï¼‰</option>
                <option value="ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ã‚·ãƒƒãƒ—ï¼ˆã‚¹ãƒ¼ãƒ„æŒ‡å®šï¼‰">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ã‚·ãƒƒãƒ—ï¼ˆã‚¹ãƒ¼ãƒ„æŒ‡å®šï¼‰</option>
                <option value="ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ã‚·ãƒƒãƒ—ï¼ˆãƒ“ã‚¸ãƒã‚¹ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ï¼‰">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ã‚·ãƒƒãƒ—ï¼ˆãƒ“ã‚¸ãƒã‚¹ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ï¼‰</option>
            </select>
        </div>

        <!-- ã‚¹ãƒ†ãƒƒãƒ—2: å…¥åŠ›æ–¹æ³• -->
        <div class="mb-6">
            <label class="block text-lg font-semibold text-gray-700 mb-3">2. å†™çœŸã‚’æº–å‚™</label>
            <div class="flex gap-4 mb-4">
                <button id="btnUseCamera" class="w-full p-3 font-semibold rounded-lg border-2 border-purple-500 text-purple-600 hover:bg-purple-50 transition-colors">
                    <span class="flex items-center justify-center gap-2"><svg class="lucide lucide-camera w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>ã‚«ãƒ¡ãƒ©ã§æ’®å½±</span>
                </button>
                <button id="btnUseUpload" class="w-full p-3 font-semibold rounded-lg border-2 border-gray-300 text-gray-600 hover:bg-gray-50 transition-colors">
                    <span class="flex items-center justify-center gap-2"><svg class="lucide lucide-upload w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</span>
                </button>
            </div>

            <!-- ã‚«ãƒ¡ãƒ©UI -->
            <div id="cameraUi" class="hidden">
                <video id="cameraStream" autoplay playsinline class="w-full rounded-lg mb-4 border border-gray-300"></video>
                <button id="captureButton" class="w-full p-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-colors active:scale-[0.98]">
                    æ’®å½±ã™ã‚‹
                </button>
                <canvas id="captureCanvas" class="hidden"></canvas> <!-- æ’®å½±ç”¨ï¼ˆéè¡¨ç¤ºï¼‰ -->
            </div>

            <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰UI -->
            <div id="uploadUi" class="hidden">
                <label id="dropZone" for="imageInput" class="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                    <svg class="lucide lucide-upload-cloud w-10 h-10 mb-3 text-gray-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>
                    <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">ã‚¯ãƒªãƒƒã‚¯</span>ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
                    <p class="text-xs text-gray-500">PNG, JPG, WEBP (5MBã¾ã§)</p>
                </label>
                <input id="imageInput" type="file" class="hidden" accept="image/png, image/jpeg, image/webp" />
            </div>
        </div>

        <!-- ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
        <div id="imagePreviewContainer" class="hidden mb-6 text-center">
            <p class="font-semibold mb-2 text-lg">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</p>
            <img id="imagePreview" src="" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ" class="max-w-md w-full max-h-96 object-contain mx-auto rounded-lg shadow-md" />
        </div>

        <!-- åˆ†æãƒœã‚¿ãƒ³ -->
        <button id="analyzeButton" disabled class="w-full flex items-center justify-center bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-xl active:scale-[0.98]">
            <svg class="lucide lucide-sparkles w-6 h-6 mr-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
            <span>åˆ†æã‚¹ã‚¿ãƒ¼ãƒˆ</span>
        </button>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
        <div id="loadingSpinner" class="hidden text-center my-8">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-lg text-gray-700">AIãŒåˆ†æä¸­ã§ã™...</p>
        </div>

        <!-- ã‚¨ãƒ©ãƒ¼ -->
        <div id="errorMessage" class="hidden my-4 p-4 bg-red-100 text-red-700 border border-red-300 rounded-lg"></div>

        <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="analysisResultContainer" class="hidden mt-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">åˆ†æçµæœ</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <!-- ç·åˆç‚¹ -->
                <div class="flex flex-col items-center justify-center bg-purple-50 p-6 rounded-lg border border-purple-200">
                    <p class="text-lg font-semibold text-purple-800">ç·åˆç‚¹</p>
                    <p class="text-7xl font-bold text-purple-600"><span id="overallScore">0</span> <span class="text-4xl">/ 100</span></p>
                    <p id="sceneForScore" class="text-center text-gray-600 mt-2"></p>
                </div>
                <!-- ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ -->
                <div class="bg-gray-50 p-4 rounded-lg flex items-center justify-center border border-gray-200">
                    <canvas id="attireRadarChart"></canvas>
                </div>
            </div>

            <!-- é …ç›®åˆ¥ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ -->
            <div id="analysisResult" class="p-6 bg-gray-50 rounded-lg border border-gray-200 text-gray-700 leading-relaxed space-y-4">
                <!-- AIã®å›ç­”ãŒã“ã“ã«å…¥ã‚‹ -->
            </div>
        </div>
    </div>
    
    <!-- â˜… ãƒ•ãƒƒã‚¿ãƒ¼ã‚’è¿½åŠ  -->
    <footer class="w-full mt-12 pb-8 text-center text-gray-500">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 border-t border-gray-200 pt-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-2">
                    <svg class="h-6 w-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/><circle cx="12" cy="10" r="3"/></svg>
                    <span class="text-lg font-semibold">å°±æ´»ã‚µãƒãƒ¼ãƒˆ</span>
                </div>
                <nav class="flex gap-4">
                    <a href="#" class="hover:text-gray-700">åˆ©ç”¨è¦ç´„</a>
                    <a href="#" class="hover:text-gray-700">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
                    <a href="#" class="hover:text-gray-700">ãŠå•ã„åˆã‚ã›</a>
                </nav>
            </div>
            <p class="mt-6 text-sm">&copy; 2024 å°±æ´»ã‚µãƒãƒ¼ãƒˆãƒãƒ¼ãƒ . All rights reserved.</p>
        </div>
    </footer>
    <!-- === ãƒ•ãƒƒã‚¿ãƒ¼ã“ã“ã¾ã§ === -->

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
        // --- è¦ç´ å–å¾— ---
        const sceneSelect = document.getElementById('sceneSelect');
        const btnUseCamera = document.getElementById('btnUseCamera');
        const btnUseUpload = document.getElementById('btnUseUpload');
        const cameraUi = document.getElementById('cameraUi');
        const uploadUi = document.getElementById('uploadUi');
        const videoEl = document.getElementById('cameraStream');
        const captureCanvas = document.getElementById('captureCanvas');
        const captureButton = document.getElementById('captureButton');
        const dropZone = document.getElementById('dropZone');
        const imageInput = document.getElementById('imageInput');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const analyzeButton = document.getElementById('analyzeButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const analysisResultContainer = document.getElementById('analysisResultContainer');
        const analysisResult = document.getElementById('analysisResult');
        const errorMessage = document.getElementById('errorMessage');
        const overallScoreEl = document.getElementById('overallScore');
        const sceneForScoreEl = document.getElementById('sceneForScore');

        // --- çŠ¶æ…‹ç®¡ç† ---
        let selectedScene = "";
        let base64Image = null;
        let mimeType = null;
        let cameraStream = null;
        let myRadarChart;

        // --- JSON ã‚¹ã‚­ãƒ¼ãƒå®šç¾© ---
        const responseSchema = {
            type: "OBJECT",
            properties: {
                "scene": { "type": "STRING" },
                "evaluation": {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            "item": { "type": "STRING" },
                            "score": { "type": "NUMBER" },
                            "comment": { "type": "STRING" }
                        }
                    }
                },
                "overallScore": { "type": "NUMBER" },
                "overallComment": {
                    type: "OBJECT",
                    properties: {
                        "goodPoints": { "type": "STRING" },
                        "suggestions": { "type": "STRING" },
                        "summary": { "type": "STRING" }
                    }
                }
            }
        };


        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        sceneSelect.addEventListener('change', (e) => {
            selectedScene = e.target.value;
            checkAnalyzeButtonState();
        });

        btnUseCamera.addEventListener('click', () => {
            selectInputMethod('camera');
            startCamera();
        });

        btnUseUpload.addEventListener('click', () => {
            selectInputMethod('upload');
            stopCamera();
        });

        captureButton.addEventListener('click', captureImage);

        // --- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç† ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
        });
        dropZone.addEventListener('drop', handleDrop, false);
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            handleFile(e.dataTransfer.files[0]);
        }

        imageInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) {
                showError("ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒ5MBã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚");
                return;
            }
            if (!['image/png', 'image/jpeg', 'image/webp'].includes(file.type)) {
                showError("PNG, JPG, WEBP å½¢å¼ã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            mimeType = file.type;
            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;
                imagePreview.src = dataUrl;
                imagePreviewContainer.classList.remove('hidden');
                base64Image = dataUrl.split(',')[1];
                checkAnalyzeButtonState();
                hideError();
            };
            reader.readAsDataURL(file);
        }

        // --- ã‚«ãƒ¡ãƒ©å‡¦ç† ---
        function selectInputMethod(method) {
            if (method === 'camera') {
                cameraUi.classList.remove('hidden');
                uploadUi.classList.add('hidden');
                btnUseCamera.classList.add('bg-purple-50', 'border-purple-500', 'text-purple-600');
                btnUseUpload.classList.remove('bg-purple-50', 'border-purple-500', 'text-purple-600');
            } else {
                cameraUi.classList.add('hidden');
                uploadUi.classList.remove('hidden');
                btnUseUpload.classList.add('bg-purple-50', 'border-purple-500', 'text-purple-600');
                btnUseCamera.classList.remove('bg-purple-50', 'border-purple-500', 'text-purple-600');
            }
        }

        async function startCamera() {
            try {
                // æ—¢å­˜ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒã‚ã‚Œã°åœæ­¢
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' }, // ãƒ•ãƒ­ãƒ³ãƒˆã‚«ãƒ¡ãƒ©
                    audio: false 
                });
                videoEl.srcObject = cameraStream;
            } catch (err) {
                console.error("Camera error:", err);
                showError("ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚");
                selectInputMethod('upload'); // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
                videoEl.srcObject = null;
            }
        }

        function captureImage() {
            const context = captureCanvas.getContext('2d');
            captureCanvas.width = videoEl.videoWidth;
            captureCanvas.height = videoEl.videoHeight;
            context.drawImage(videoEl, 0, 0, videoEl.videoWidth, videoEl.videoHeight);
            
            const dataUrl = captureCanvas.toDataURL('image/jpeg'); // JPEGã§å›ºå®š
            mimeType = 'image/jpeg';
            base64Image = dataUrl.split(',')[1];
            
            imagePreview.src = dataUrl;
            imagePreviewContainer.classList.remove('hidden');
            checkAnalyzeButtonState();
            stopCamera(); // æ’®å½±ã—ãŸã‚‰ã‚«ãƒ¡ãƒ©ã‚’æ­¢ã‚ã‚‹
            cameraUi.classList.add('hidden'); // ã‚«ãƒ¡ãƒ©UIã‚’éš ã™
        }

        // --- åˆ†æãƒœã‚¿ãƒ³ã®åˆ¶å¾¡ ---
        function checkAnalyzeButtonState() {
            if (selectedScene && base64Image) {
                analyzeButton.disabled = false;
            } else {
                analyzeButton.disabled = true;
            }
        }
        analyzeButton.addEventListener('click', callGeminiApi);

        // --- Gemini API å‘¼ã³å‡ºã— (JSONãƒ¢ãƒ¼ãƒ‰) ---
        async function callGeminiApi() {
            loadingSpinner.classList.remove('hidden');
            analyzeButton.disabled = true;
            analyzeButton.querySelector('span').textContent = 'åˆ†æä¸­ã§ã™...';
            hideError();
            analysisResultContainer.classList.add('hidden');

            const apiKey = ""; // CanvasãŒè‡ªå‹•æŒ¿å…¥
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const systemPrompt = `
ã‚ãªãŸã¯ãƒ—ãƒ­ã®å°±æ´»ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã—ãŸå ´é¢ï¼ˆã‚·ãƒ¼ãƒ³ï¼‰ã«åŸºã¥ãã€æä¾›ã•ã‚ŒãŸç”»åƒã®æœè£…ã¨èº«ã ã—ãªã¿ã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚
è©•ä¾¡é …ç›®ã¯ã€Œæ¸…æ½”æ„Ÿã€ã€Œãƒ•ã‚©ãƒ¼ãƒãƒ«åº¦ã€ã€Œã‚µã‚¤ã‚ºæ„Ÿã€ã€Œé«ªå‹ã€ã€Œè¡¨æƒ…/å§¿å‹¢ã€ã®5é …ç›®ã‚’å„5ç‚¹æº€ç‚¹ã§æ¡ç‚¹ã—ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚
æœ€å¾Œã«ç·åˆç‚¹ã‚’100ç‚¹æº€ç‚¹ã§ç®—å‡ºã—ã€å…¨ä½“çš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆè‰¯ã„ç‚¹ã€æ”¹å–„ææ¡ˆã€ç·è©•ï¼‰ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚
å¿…ãšæŒ‡å®šã•ã‚ŒãŸJSONã‚¹ã‚­ãƒ¼ãƒã«å¾“ã£ã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚
`;

            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: `ã“ã®æœè£…ã‚’ã€Œ${selectedScene}ã€ã®å ´é¢ã‚’æƒ³å®šã—ã¦è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚` },
                            {
                                inlineData: {
                                    mimeType: mimeType,
                                    data: base64Image
                                }
                            }
                        ]
                    }
                ],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${response.status} ${response.statusText}`);
                }
                const result = await response.json();
                
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    const data = JSON.parse(jsonString);
                    displayResult(data);
                } else {
                    showError("AIãŒå¿œç­”ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®ç”»åƒã§è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚");
                }
            } catch (error) {
                console.error("Fetch error:", error);
                showError(`åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            } finally {
                loadingSpinner.classList.add('hidden');
                analyzeButton.disabled = false;
                analyzeButton.querySelector('span').textContent = 'å†åº¦åˆ†æã™ã‚‹';
                stopCamera();
            }
        }
        
        // --- çµæœè¡¨ç¤º ---
        function displayResult(data) {
            analysisResultContainer.classList.remove('hidden');

            overallScoreEl.textContent = data.overallScore || 0;
            sceneForScoreEl.textContent = `ï¼ˆ${data.scene || selectedScene}ã§ã®è©•ä¾¡ï¼‰`;

            const ctx = document.getElementById('attireRadarChart').getContext('2d');
            const labels = data.evaluation.map(item => item.item);
            const scores = data.evaluation.map(item => item.score);

            if (myRadarChart) {
                myRadarChart.destroy(); // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            }
            myRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'é …ç›®åˆ¥è©•ä¾¡ (5ç‚¹æº€ç‚¹)',
                        data: scores,
                        backgroundColor: 'rgba(109, 40, 217, 0.2)', // purple-600
                        borderColor: 'rgba(109, 40, 217, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(109, 40, 217, 1)'
                    }]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: { display: true },
                            suggestedMin: 0,
                            suggestedMax: 5, // 5ç‚¹æº€ç‚¹
                            ticks: { stepSize: 1 },
                            pointLabels: { font: { size: 14 } }
                        }
                    },
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });

            const comment = data.overallComment;
            analysisResult.innerHTML = `
                <h3 class="text-green-700">âœ”ï¸ è‰¯ã„ç‚¹ (Good Points)</h3>
                <p>${comment.goodPoints.replace(/\n/g, '<br>')}</p>
                
                <h3 class="text-amber-700">âš ï¸ æ”¹å–„ææ¡ˆ (Suggestions)</h3>
                <p>${comment.suggestions.replace(/\n/g, '<br>')}</p>
                
                <h3 class="text-gray-800">ğŸ’¡ ç·è©• (Summary)</h3>
                <p>${comment.summary.replace(/\n/g, '<br>')}</p>
                
                <h3 class="text-gray-800">ğŸ” é …ç›®åˆ¥ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
                <ul>
                    ${data.evaluation.map(item => `
                        <li><strong>${item.item} (${item.score}/5):</strong> ${item.comment}</li>
                    `).join('')}
                </ul>
            `;
            // ã‚¢ã‚¤ã‚³ãƒ³ã‚’å†æç”»
            lucide.createIcons();
        }


        // --- UIãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }
        function hideError() {
            errorMessage.textContent = '';
            errorMessage.classList.add('hidden');
        }

        // --- APIãƒªãƒˆãƒ©ã‚¤ ---
        async function fetchWithBackoff(url, options, maxRetries = 3, baseDelay = 1000) {
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 429) {
                        const delay = baseDelay * Math.pow(2, attempt);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        attempt++;
                    } else {
                        return response;
                    }
                } catch (error) {
                    if (attempt + 1 >= maxRetries) {
                        throw error;
                    }
                    const delay = baseDelay * Math.pow(2, attempt);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    attempt++;
                }
            }
            throw new Error('API request failed after all retries.');
        }
        
        // --- åˆæœŸåŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            selectInputMethod('upload'); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            lucide.createIcons();
        });
        
    </script>
</body>
</html>