<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>適正診断 - Job Compass</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;700;900&display=swap');

        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f8fafc;
            /* slate-50 */
            color: #0f172a;
            /* slate-900 */
            -webkit-font-smoothing: antialiased;
            padding-top: 4rem;
            /* 64px */
        }

        /* 背景の微細なグリッドパターン */
        .bg-grid-pattern {
            background-image: linear-gradient(to right, #e2e8f0 1px, transparent 1px),
                linear-gradient(to bottom, #e2e8f0 1px, transparent 1px);
            background-size: 40px 40px;
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
            -webkit-mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
            opacity: 0.4;
            position: fixed;
            inset: 0;
            z-index: -1;
        }

        /* 質問カード */
        .bunseki-card {
            background: white;
            border-radius: 1.5rem;
            border: 1px solid #f1f5f9;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
            transition: all 0.3s ease;
        }

        /* 質問文のコンテナ */
        .question-text-container {
            min-height: 6rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- 丸い選択ボタンのスタイル (7段階対応) --- */
        .scale-option {
            border-radius: 50%;
            border: 2px solid;
            background-color: transparent;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 2px;
            /* ボタン同士の間隔 */
        }

        /* ホバー時の挙動 */
        .scale-option:hover {
            transform: scale(1.15) translateY(-2px);
            z-index: 10;
        }

        /* 選択されたとき */
        .scale-option.selected {
            background-color: currentColor;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 1), 0 0 0 5px currentColor;
        }

        /* 各ボタンの定義 (色とサイズ - 7段階) */
        .opt-7 {
            border-color: #10b981;
            color: #10b981;
            width: 3.5rem;
            height: 3.5rem;
            background-color: #ecfdf5;
        }

        .opt-6 {
            border-color: #34d399;
            color: #34d399;
            width: 3rem;
            height: 3rem;
            background-color: #f0fdf4;
        }

        .opt-5 {
            border-color: #6ee7b7;
            color: #6ee7b7;
            width: 2.5rem;
            height: 2.5rem;
            background-color: #f0fdf4;
        }

        .opt-4 {
            border-color: #94a3b8;
            color: #94a3b8;
            width: 2.25rem;
            height: 2.25rem;
            background-color: #f8fafc;
        }

        .opt-3 {
            border-color: #c4b5fd;
            color: #c4b5fd;
            width: 2.5rem;
            height: 2.5rem;
            background-color: #f5f3ff;
        }

        .opt-2 {
            border-color: #a78bfa;
            color: #a78bfa;
            width: 3rem;
            height: 3rem;
            background-color: #f5f3ff;
        }

        .opt-1 {
            border-color: #8b5cf6;
            color: #8b5cf6;
            width: 3.5rem;
            height: 3.5rem;
            background-color: #ede9fe;
        }

        @media (max-width: 640px) {

            .opt-7,
            .opt-1 {
                width: 3rem;
                height: 3rem;
            }

            .opt-6,
            .opt-2 {
                width: 2.5rem;
                height: 2.5rem;
            }

            .opt-5,
            .opt-3 {
                width: 2rem;
                height: 2rem;
            }

            .opt-4 {
                width: 1.75rem;
                height: 1.75rem;
            }

            .scale-option {
                margin: 0 1px;
            }
        }

        /* アニメーション */
        .fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ローディング */
        .dot {
            animation: pulse 1.4s infinite ease-in-out both;
        }

        .dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes pulse {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <div class="bg-grid-pattern"></div>

    <nav
        class="fixed top-0 left-0 right-0 bg-white/80 backdrop-blur-md border-b border-slate-200 z-50 h-16 transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full">
            <div class="flex justify-between items-center h-full">
                <a href="home.html" class="flex items-center gap-2 group">
                    <svg class="h-8 w-8 text-blue-600 transition-transform group-hover:scale-110"
                        xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z" />
                        <circle cx="12" cy="10" r="3" />
                    </svg>
                    <span class="text-xl font-bold tracking-tight text-slate-900">Job Compass</span>
                </a>
                <div class="hidden md:flex items-center gap-1">
                    <a href="sindan.html"
                        class="px-4 py-2 rounded-full text-sm font-medium text-slate-900 bg-slate-100 transition-all">適正診断</a>
                    <a href="camera.html"
                        class="px-4 py-2 rounded-full text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-100 transition-all">服装分析</a>
                    <a href="mensetu.html"
                        class="px-4 py-2 rounded-full text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-100 transition-all">模擬面接</a>
                </div>
                <div class="flex items-center gap-3">
                    <a href="home.html"
                        class="flex items-center text-sm font-bold text-slate-500 hover:text-slate-900 px-2 transition-colors">
                        <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                        </svg>
                        ホームに戻る
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div id="bunsekiAppContainer" class="flex-grow w-full flex items-center justify-center p-4 sm:p-6 py-12">
        <div id="bunsekiContent" class="w-full max-w-2xl">
        </div>
    </div>

    <div id="errorMessage"
        class="hidden fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded shadow-md z-50">
        <span id="errorText"></span>
    </div>

    <footer class="w-full bg-white border-t border-slate-200 py-10 mt-auto">
        <div class="max-w-7xl mx-auto px-4 text-center text-xs text-slate-400">&copy; 2025 Career Support AI. All rights
            reserved.</div>
    </footer>

    <script>
        const bunsekiContent = document.getElementById('bunsekiContent');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        let radarChartInstance = null;

        // --- 状態変数 ---
        let stage1Scores = {
            action: 0,      // 行動力
            logic: 0,       // 論理力
            team: 0,        // 協調性
            creative: 0,    // 創造性
            resilience: 0   // 精神力
        };
        let stage2Scores = {};
        let topCategory = '';
        let currentStage1Question = 0;
        let currentStage2Question = 0;
        let userProfile = null; // プロフィール情報

        // 履歴管理
        let answerHistory = [];

        // --- 画像のマッピング ---
        const categoryImages = {
            action: 'image/koudou.png',
            logic: 'image/ronri.png',
            team: 'image/kyoutyou.png',
            creative: 'image/souzou.png',
            resilience: 'image/seisin.png'
        };

        // --- プロフィール取得 ---
        function getProfile() {
            const SESSION_KEY = 'career_app_session';
            const PROFILE_KEY_PREFIX = 'career_app_profile_';
            const user = JSON.parse(localStorage.getItem(SESSION_KEY));
            if (!user) return null;
            return JSON.parse(localStorage.getItem(PROFILE_KEY_PREFIX + user.id));
        }

        // --- 質問データ (STEP1: 15問) ---
        const stage1Questions = [
            // Action (行動力)
            { text: "失敗を恐れず、まずは行動してみることが大切だと思う", category: "action" },
            { text: "自ら率先してリーダーシップを発揮することが多い", category: "action" },
            { text: "高い目標に対しても、情熱を持って挑戦し続けられる", category: "action" },

            // Logic (論理力)
            { text: "物事を進める前に、計画や段取りをしっかり考える方だ", category: "logic" },
            { text: "現状を分析して、隠れた問題点を見つけるのが得意だ", category: "logic" },
            { text: "リスクを事前に予測し、回避策を準備して行動する", category: "logic" },

            // Team (協調性)
            { text: "自分の意見よりも、チーム全体の合意を重視する", category: "team" },
            { text: "初対面の人ともすぐに打ち解け、信頼関係を築ける", category: "team" },
            { text: "相手の話を親身になって聞くことができる", category: "team" },

            // Creative (創造性)
            { text: "既存のルールにとらわれず、新しい方法を考えるのが好きだ", category: "creative" },
            { text: "変化を楽しみ、臨機応変に対応できる", category: "creative" },
            { text: "独自の視点でアイデアを出すことがよくある", category: "creative" },

            // Resilience (精神力)
            { text: "困難な壁にぶつかっても、粘り強く取り組む自信がある", category: "resilience" },
            { text: "責任感が強く、任された仕事は最後までやり抜く", category: "resilience" },
            { text: "ストレスを感じる状況でも、冷静さを保つことができる", category: "resilience" }
        ];

        // --- 質問データ (STEP2: 各カテゴリ5問) ---
        const stage2QuestionsData = {
            action: [
                { text: "一度決めたことは、何があっても最後までやり抜く", element: "実行力" },
                { text: "目標達成のためなら、泥臭い努力もいとわない", element: "実行力" },
                { text: "自分から積極的に周囲に働きかけ、協力を仰ぐことができる", element: "働きかけ力" },
                { text: "自ら課題を見つけ、指示を待たずに動くことができる", element: "主体性" },
                { text: "未経験の分野でも、物怖じせずに飛び込むことができる", element: "チャレンジ精神" }
            ],
            logic: [
                { text: "「なぜ？」と疑問を持ち、根本的な原因を突き止めるのが好きだ", element: "課題発見力" },
                { text: "データや事実に基づいて、客観的に物事を判断する", element: "課題発見力" },
                { text: "ゴールから逆算して、無理のないスケジュールを立てることができる", element: "計画力" },
                { text: "複雑な情報を整理し、要点を分かりやすくまとめるのが得意だ", element: "構造化能力" },
                { text: "感情に流されず、メリット・デメリットを冷静に比較検討できる", element: "判断力" }
            ],
            team: [
                { text: "複雑な物事を、誰にでも分かる言葉で説明するのが得意だ", element: "発信力" },
                { text: "チームの雰囲気を盛り上げ、一体感を作るのが得意だ", element: "柔軟性" },
                { text: "相手の立場に立って物事を考え、共感することができる", element: "傾聴力" },
                { text: "意見が対立した際、妥協点を見つけて調整するのが得意だ", element: "調整力" },
                { text: "チームのルールや約束事を尊重し、規律を守ることを大切にする", element: "規律性" }
            ],
            creative: [
                { text: "誰も思いつかないような斬新なアイデアを出すのが得意だ", element: "創造力" },
                { text: "状況の変化に合わせて、柔軟にやり方を変えることができる", element: "柔軟性" },
                { text: "現状に満足せず、常により良い方法を探求している", element: "改善力" },
                { text: "異分野の知識を組み合わせて、新しいアイデアを生み出すのが好きだ", element: "発想力" },
                { text: "「当たり前」を疑い、常に新しい可能性を探っている", element: "探究心" }
            ],
            resilience: [
                { text: "プレッシャーがかかる場面でも、実力を発揮できる", element: "ストレス耐性" },
                { text: "地味な作業でも、コツコツと真面目に取り組める", element: "継続力" },
                { text: "自分の役割を理解し、責任を持って全うする", element: "規律性" },
                { text: "予期せぬトラブルが起きても、パニックにならず冷静に対処できる", element: "状況対応力" },
                { text: "批判や失敗を成長の糧として、ポジティブに受け止めることができる", element: "受容力" }
            ]
        };

        // --- JSON スキーマ定義 ---
        const responseSchema = {
            type: "OBJECT",
            properties: {
                "element": { "type": "STRING" },
                "category": { "type": "STRING" },
                "direction": { "type": "STRING" },
                "example": { "type": "STRING" },
                "advice": { "type": "ARRAY", "items": { "type": "STRING" } },
                "industryFit": { "type": "STRING" }
            },
            required: ["element", "category", "direction", "example", "advice", "industryFit"]
        };

        // 戻るボタンのHTML生成
        function getBackButtonHtml() {
            const visibilityClass = answerHistory.length === 0 ? 'invisible pointer-events-none' : '';
            return `
                <button onclick="handleBack()" class="mt-8 mx-auto flex items-center justify-center text-slate-400 hover:text-slate-600 transition-colors text-sm font-bold gap-1 py-2 px-4 rounded-lg hover:bg-slate-50 ${visibilityClass}">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    一つ前の質問に戻る
                </button>
            `;
        }

        // 戻る処理
        window.handleBack = function () {
            if (answerHistory.length === 0) return;
            const lastAction = answerHistory.pop();

            if (lastAction.stage === 1) {
                stage1Scores[lastAction.key] -= lastAction.score;
                currentStage1Question--;
                renderStage1Question();
            } else if (lastAction.stage === 2) {
                stage2Scores[lastAction.key] -= lastAction.score;
                currentStage2Question--;

                if (currentStage2Question < 0) {
                    currentStage2Question = 0;
                    renderStage2Question();
                } else {
                    renderStage2Question();
                }
            }
        };

        // --- 画面描画関数 ---
        function renderStart() {
            answerHistory = [];
            userProfile = getProfile();

            let targetText = "あなたの志望企業に合わせた診断を行います";
            if (userProfile && userProfile.company) {
                targetText = `<span class="font-bold text-blue-600">${userProfile.company}</span> 向けの適正診断を行います`;
            } else if (userProfile && userProfile.industry) {
                targetText = `<span class="font-bold text-blue-600">${userProfile.industry}業界</span> 向けの適正診断を行います`;
            } else {
                targetText = "プロフィールが設定されていません。<br>ホーム画面から設定すると、より正確なアドバイスが得られます。";
            }

            bunsekiContent.innerHTML = `
                <div class="bunseki-card w-full p-10 md:p-14 text-center fade-in">
                    <div class="w-20 h-20 bg-blue-50 rounded-2xl flex items-center justify-center mb-8 text-blue-600 shadow-sm mx-auto">
                        <svg class="lucide lucide-file-text w-10 h-10" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
                    </div>
                    <h1 class="text-3xl md:text-4xl font-bold text-slate-900 mb-4">適正診断</h1>
                    <p class="text-lg text-slate-500 mb-8 leading-relaxed">
                        5つの観点からあなたの強みを分析します。<br>
                        （行動力・論理力・協調性・創造性・精神力）
                    </p>
                    
                    <div class="bg-blue-50 rounded-xl p-4 mb-10 text-center">
                        <p class="text-slate-700">${targetText}</p>
                    </div>

                    <button id="startButton" class="w-full md:w-auto text-xl font-bold bg-blue-600 text-white py-4 px-12 rounded-xl shadow-lg shadow-blue-200 hover:bg-blue-700 hover:shadow-blue-300 transition-all active:scale-[0.98]">
                        診断スタート
                    </button>
                </div>
            `;

            bunsekiContent.querySelector('#startButton').addEventListener('click', () => {
                startStage1();
            });
            lucide.createIcons();
        }

        function startStage1() {
            stage1Scores = { action: 0, logic: 0, team: 0, creative: 0, resilience: 0 };
            currentStage1Question = 0;
            renderStage1Question();
        }

        function renderStage1Question() {
            if (currentStage1Question >= stage1Questions.length) {
                calculateStage1Result();
                return;
            }
            const q = stage1Questions[currentStage1Question];
            const progress = ((currentStage1Question + 1) / stage1Questions.length) * 100;

            bunsekiContent.innerHTML = `
                <div class="bunseki-card p-8 md:p-12 fade-in">
                    <div class="mb-8">
                        <div class="flex justify-between items-end mb-2">
                            <span class="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-full">STEP 1</span>
                            <span class="text-xs font-mono text-slate-400">${currentStage1Question + 1} / ${stage1Questions.length}</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                            <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    
                    <div class="question-text-container mb-8">
                        <h2 class="text-xl md:text-2xl font-bold text-slate-900 leading-snug text-center">${q.text}</h2>
                    </div>

                    <div class="flex flex-col items-center gap-4">
                            <div class="flex items-center justify-between w-full max-w-sm px-4">
                            <span class="text-sm font-bold text-emerald-600">そう思う</span>
                            <span class="text-sm font-bold text-violet-600">そう思わない</span>
                        </div>
                        <div class="flex items-center justify-center gap-2 sm:gap-4 w-full flex-wrap sm:flex-nowrap">
                            <div class="scale-option opt-7" onclick="handleStage1Answer(7)" role="button"></div>
                            <div class="scale-option opt-6" onclick="handleStage1Answer(6)" role="button"></div>
                            <div class="scale-option opt-5" onclick="handleStage1Answer(5)" role="button"></div>
                            <div class="scale-option opt-4" onclick="handleStage1Answer(4)" role="button"></div>
                            <div class="scale-option opt-3" onclick="handleStage1Answer(3)" role="button"></div>
                            <div class="scale-option opt-2" onclick="handleStage1Answer(2)" role="button"></div>
                            <div class="scale-option opt-1" onclick="handleStage1Answer(1)" role="button"></div>
                        </div>
                        <div class="text-xs text-slate-400 mt-2">直感でお答えください</div>
                    </div>
                    
                    ${getBackButtonHtml()}
                </div>
            `;
            lucide.createIcons();
        }

        window.handleStage1Answer = function (score) {
            const btn = event.target;
            btn.classList.add('selected');
            setTimeout(() => {
                const category = stage1Questions[currentStage1Question].category;

                answerHistory.push({
                    stage: 1,
                    key: category,
                    score: score
                });

                stage1Scores[category] += score;
                currentStage1Question++;
                renderStage1Question();
            }, 300);
        };

        function calculateStage1Result() {
            topCategory = Object.keys(stage1Scores).reduce((a, b) => stage1Scores[a] > stage1Scores[b] ? a : b);

            currentStage2Question = 0;
            stage2Scores = {};
            if (stage2QuestionsData[topCategory]) {
                stage2QuestionsData[topCategory].forEach(q => { stage2Scores[q.element] = 0; });
            } else {
                console.error("Category not found:", topCategory);
                topCategory = 'action';
                stage2QuestionsData['action'].forEach(q => { stage2Scores[q.element] = 0; });
            }
            renderStage2Question();
        }

        function renderStage2Question() {
            const questions = stage2QuestionsData[topCategory];
            if (currentStage2Question >= questions.length) {
                calculateStage2Result();
                return;
            }
            const q = questions[currentStage2Question];
            const progress = ((currentStage2Question + 1) / questions.length) * 100;

            const categoryNames = {
                action: '行動力',
                logic: '論理力',
                team: '協調性',
                creative: '創造性',
                resilience: '精神力'
            };
            const categoryName = categoryNames[topCategory];

            bunsekiContent.innerHTML = `
                <div class="bunseki-card p-8 md:p-12 fade-in border-t-4 border-t-indigo-500">
                    <div class="mb-8">
                            <div class="flex justify-between items-end mb-2">
                            <span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full">STEP 2: ${categoryName}</span>
                            <span class="text-xs font-mono text-slate-400">${currentStage2Question + 1} / ${questions.length}</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                            <div class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    
                    <div class="question-text-container mb-8">
                        <h2 class="text-xl md:text-2xl font-bold text-slate-900 leading-snug text-center">${q.text}</h2>
                    </div>

                    <div class="flex flex-col items-center gap-4">
                            <div class="flex items-center justify-between w-full max-w-sm px-4">
                            <span class="text-sm font-bold text-emerald-600">そう思う</span>
                            <span class="text-sm font-bold text-violet-600">そう思わない</span>
                        </div>
                        <div class="flex items-center justify-center gap-2 sm:gap-4 w-full flex-wrap sm:flex-nowrap">
                            <div class="scale-option opt-7" onclick="handleStage2Answer(7)" role="button"></div>
                            <div class="scale-option opt-6" onclick="handleStage2Answer(6)" role="button"></div>
                            <div class="scale-option opt-5" onclick="handleStage2Answer(5)" role="button"></div>
                            <div class="scale-option opt-4" onclick="handleStage2Answer(4)" role="button"></div>
                            <div class="scale-option opt-3" onclick="handleStage2Answer(3)" role="button"></div>
                            <div class="scale-option opt-2" onclick="handleStage2Answer(2)" role="button"></div>
                            <div class="scale-option opt-1" onclick="handleStage2Answer(1)" role="button"></div>
                        </div>
                        <div class="text-xs text-slate-400 mt-2">直感でお答えください</div>
                    </div>

                    ${getBackButtonHtml()}
                </div>
            `;
            lucide.createIcons();
        }

        window.handleStage2Answer = function (score) {
            const btn = event.target;
            btn.classList.add('selected');
            setTimeout(() => {
                const q = stage2QuestionsData[topCategory][currentStage2Question];

                answerHistory.push({
                    stage: 2,
                    key: q.element,
                    score: score
                });

                stage2Scores[q.element] += score;
                currentStage2Question++;
                renderStage2Question();
            }, 300);
        };

        function calculateStage2Result() {
            let maxScore = -1;
            let finalElement = "";
            for (const [element, score] of Object.entries(stage2Scores)) {
                if (score > maxScore) {
                    maxScore = score;
                    finalElement = element;
                }
            }
            callGeminiApi(finalElement);
        }

        async function callGeminiApi(finalElement) {
            let userProfile = getProfile() || {};
            // サーバーに送るリクエストデータを作成
            const requestData = {
                element: finalElement,
                category: topCategory, // グローバル変数から取得
                userProfile: userProfile
            };

            bunsekiContent.innerHTML = `
                <div class="text-center p-12 fade-in">
                    <div class="flex justify-center items-center gap-3 mb-6">
                        <div class="dot w-4 h-4 bg-blue-600 rounded-full"></div>
                        <div class="dot w-4 h-4 bg-indigo-600 rounded-full"></div>
                        <div class="dot w-4 h-4 bg-sky-500 rounded-full"></div>
                    </div>
                    <h2 class="text-3xl font-bold text-slate-900">分析中...</h2>
                    <p class="text-lg text-slate-500 mt-2">
                        <span class="font-bold text-indigo-600">AI</span> があなたのアピールポイントを生成しています
                    </p>
                </div>
            `;

            try {
                const response = await fetch('http://localhost:3000/api/sindan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    if (response.status === 429) {
                        throw new Error(errorData.message || "アクセス集中等のため一時的に利用できません。時間をおいて再度お試しください。");
                    }
                    throw new Error('API request failed');
                }

                const data = await response.json();

                // データ形式を合わせる (categoryは日本語名にする必要あり)
                const categoryNames = {
                    action: '行動力',
                    logic: '論理力',
                    team: '協調性',
                    creative: '創造性',
                    resilience: '精神力'
                };

                const resultData = {
                    element: finalElement,
                    category: categoryNames[topCategory],
                    industryFit: data.industryFit,
                    direction: data.direction,
                    advice: data.advice,
                    example: data.example
                };

                // 履歴保存
                let companyName = userProfile.company || userProfile.industry || "一般企業";
                saveHistory(resultData, companyName);

                renderResult(resultData, companyName);

            } catch (error) {
                console.error('Error:', error);
                bunsekiContent.innerHTML = `
                    <div class="text-center p-12 text-red-600">
                        <p class="font-bold text-xl">エラーが発生しました</p>
                        <p class="mt-2 text-sm">サーバーとの通信に失敗しました。サーバーが起動しているか確認してください。</p>
                        <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-slate-200 rounded-lg hover:bg-slate-300">最初に戻る</button>
                    </div>
                `;
            }
        }

        // ★ 履歴保存関数 ★
        function saveHistory(data, companyName) {
            try {
                const SESSION_KEY = 'career_app_session';
                const HISTORY_KEY_PREFIX = 'career_app_history_';

                const user = JSON.parse(localStorage.getItem(SESSION_KEY));
                if (!user) return; // ログインしていなければ保存しない

                const key = HISTORY_KEY_PREFIX + user.id;
                const histories = JSON.parse(localStorage.getItem(key) || '[]');

                const now = new Date();
                const dateStr = now.getFullYear() + '/' + (now.getMonth() + 1) + '/' + now.getDate() + ' ' + now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');

                const newHistory = {
                    id: Date.now(),
                    type: 'sindan',
                    date: dateStr,
                    title: `強み：${data.element}`,
                    summary: `対象: ${companyName} / カテゴリ: ${data.category}`,
                    detail: { ...data, scores: stage1Scores }
                };

                histories.push(newHistory);
                localStorage.setItem(key, JSON.stringify(histories));
                console.log("History saved");

            } catch (e) {
                console.error("Save history failed", e);
            }
        }

        function renderResult(result, companyName) {
            // 画像パスの決定
            const imagePath = categoryImages[topCategory];

            bunsekiContent.innerHTML = `
                <div class="bunseki-card w-full max-w-4xl mx-auto p-8 md:p-12 fade-in">
                    <div class="text-center mb-12">
                        <p class="text-sm font-bold text-blue-600 tracking-widest uppercase mb-3">ANALYSIS RESULT</p>
                        <h1 class="text-3xl md:text-4xl font-bold text-slate-900 mb-6">あなたの最大の武器</h1>
                        
                        <div class="mb-8">
                            <img src="${imagePath}" alt="${result.category}" class="w-full max-w-md mx-auto rounded-3xl shadow-lg transform transition hover:scale-105 duration-500">
                        </div>


                    </div>

                    <div class="bg-blue-50 border border-blue-100 rounded-3xl p-8 mb-12 text-center">
                        <h3 class="text-lg font-bold text-blue-900 mb-3 flex items-center justify-center gap-2">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                            ${companyName} への適性
                        </h3>
                        <p class="text-blue-800 leading-relaxed font-medium text-lg">
                            ${result.industryFit}
                        </p>
                    </div>

                    <!-- Chart Section -->
                    <div class="bg-slate-50 rounded-3xl p-8 border border-slate-100 mb-12">
                        <h2 class="text-xl font-bold text-slate-700 mb-6 text-center">基礎力バランス</h2>
                        <div class="aspect-video relative max-w-3xl mx-auto">
                            <canvas id="resultRadarChart"></canvas>
                        </div>
                    </div>

                    <!-- Cards Section (Vertical Stack) -->
                    <div class="flex flex-col gap-8 mb-12">
                        <!-- Direction -->
                        <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 hover:border-blue-200 transition-colors">
                            <h3 class="font-bold text-slate-900 mb-3 flex items-center">
                                <div class="p-1.5 bg-blue-100 rounded-lg mr-3 text-blue-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg></div>
                                アピールの方向性
                            </h3>
                            <p class="text-slate-600 leading-relaxed">${result.direction}</p>
                        </div>

                        <!-- Advice -->
                        <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 hover:border-indigo-200 transition-colors">
                            <h3 class="font-bold text-slate-900 mb-3 flex items-center">
                                <div class="p-1.5 bg-indigo-100 rounded-lg mr-3 text-indigo-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                                プロのアドバイス
                            </h3>
                            <ul class="list-disc list-inside text-slate-600 leading-relaxed">
                                ${result.advice.map(a => `<li>${a}</li>`).join('')}
                            </ul>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-slate-50 to-blue-50 rounded-3xl p-8 md:p-10 border border-blue-100 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-6 opacity-5">
                                <svg class="w-32 h-32 text-blue-900" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path></svg>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center relative z-10">
                            <svg class="lucide lucide-edit w-6 h-6 inline-block mr-3 text-blue-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            自己PR例文
                        </h2>
                        <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-6 md:p-8 border border-white shadow-sm text-slate-700 leading-relaxed relative z-10 text-lg">
                            ${result.example}
                        </div>
                    </div>

                    <button id="restartButton" class="w-full mt-12 text-lg font-semibold bg-slate-100 text-slate-700 py-4 px-8 rounded-xl hover:bg-slate-200 transition-colors">
                        もう一度診断する
                    </button>
                </div>
            `;

            // ★ ロジック変更: 7段階評価に対応 & 1.5乗計算でマイルドに ★

            // 1. STEP2の結果をトップカテゴリに合算 (トップを伸ばす)
            let step2Total = 0;
            Object.values(stage2Scores).forEach(val => step2Total += val);

            // 表示用のスコアコピーを作成
            let finalScores = { ...stage1Scores };
            finalScores[topCategory] += step2Total; // トップカテゴリにブースト

            // 2. 差分強調 (間を取って1.5乗)
            const emphasize = (val) => Math.pow(val, 1.5);

            const chartData = [
                emphasize(finalScores.action),
                emphasize(finalScores.logic),
                emphasize(finalScores.team),
                emphasize(finalScores.creative),
                emphasize(finalScores.resilience)
            ];

            const maxScore = Math.max(...chartData);

            // スケール調整
            const suggestedMax = Math.max(maxScore * 1.1, 100);

            const ctx = bunsekiContent.querySelector('#resultRadarChart').getContext('2d');
            if (radarChartInstance) radarChartInstance.destroy();
            radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['行動力', '論理力', '協調性', '創造性', '精神力'],
                    datasets: [{
                        label: 'あなたの傾向',
                        data: chartData,
                        backgroundColor: 'rgba(37, 99, 235, 0.2)',
                        borderColor: '#2563eb',
                        borderWidth: 3,
                        pointBackgroundColor: '#2563eb',
                        pointBorderColor: '#fff',
                        pointRadius: 5
                    }]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: { display: true, color: '#e2e8f0' },
                            grid: { color: '#e2e8f0' },
                            suggestedMin: 0,
                            suggestedMax: suggestedMax,
                            ticks: { display: false },
                            pointLabels: {
                                font: { size: 14, family: 'Noto Sans JP', weight: 'bold' },
                                color: '#475569'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
            bunsekiContent.querySelector('#restartButton').addEventListener('click', renderStart);
            lucide.createIcons();
        }

        // --- UIヘルパー ---
        function showError(message) { alert(message); }

        // --- 初期化実行 ---
        document.addEventListener('DOMContentLoaded', () => {
            renderStart();
            lucide.createIcons();
        });
    </script>
</body>

</html>